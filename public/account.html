<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mon Compte - RGPD Trankility</title>
<link rel="stylesheet" href="style-account.css">
<link rel="icon" type="image/x-icon" href="/images/logo_rgpd_trankility.ico">
<link rel="apple-touch-icon" sizes="180x180" href="/images/logo_rgpd_trankility.png">
<link rel="icon" sizes="192x192" href="/images/logo_rgpd_trankility.png">
<link rel="icon" sizes="512x512" href="/images/logo_rgpd_trankility.png">
</head>
<body>
<header>
    <div class="logo">
        <a href="index.html"><img src="images/logo_rgpd_trankility.png" alt="Logo RGPD Trankility"></a>
    </div>
    <nav>
        <a href="login.html" id="logoutBtn">Déconnexion</a>
    </nav>
</header>

<main>
    <div class="menu">
        <button class="tab-btn active" data-tab="monCompte">Mon Compte</button>
		<button class="tab-btn" data-tab="IARGPD">Assitant IA RGPD</button>
        <button class="tab-btn" data-tab="FormulaireRGPD">Formulaire RGPD</button>
        <button class="tab-btn" data-tab="RegenererUnDocument">Regénérer un document</button>
        <button class="tab-btn" data-tab="historiqueGeneration">Historique de génération</button>
		<button class="tab-btn" data-tab="SuivideConformite">Suivi de conformité</button>
        <button class="tab-btn" data-tab="contactSupport">Contact & Support</button>
    </div>

    <div class="content">
        <!-- Mon Compte -->
        <section id="monCompte" class="active">
            <h2 id="welcomeMsg">Bienvenue sur votre compte</h2>
            <p>Gérez vos paramètres RGPD et consultez l’historique des consentements ici.</p>
        </section>
		
		<!-- Assitant IA RGPD -->
        <section id="IARGPD">		
            <h2>Assitant IA RGPD</h2>			  
			<input type="text" id="userInput" placeholder="Écris un message..." />
			<button id="sendBtn">Envoyer</button>
			<div id="response"></div>
			<script src="iargpd.js"></script>
        </section>

        <!-- Formulaire RGPD -->
        <section id="FormulaireRGPD">
            <h2>Formulaire RGPD</h2>
            <div id="formulaireContainer"></div>
        </section>

        <!-- Regénérer un document -->
        <section id="RegenererUnDocument">
            <h2>Regénérer un document</h2>
            <select id="docSelect">
                <option value="">-- Choisissez un document --</option>
                <option value="Politique de confidentialité RGPD">Politique de confidentialité RGPD</option>
            </select>
            <button id="generateBtn">Générer</button>
            <div id="regenResult"></div>
        </section>

		<!-- Historique --> 
		<section id="historiqueGeneration"> 
			<h2>Historique de génération</h2> 
			<div id="historyList"><p>Aucun document généré pour le moment.</p></div> 
		</section>
		
        <!-- Suivi de conformité -->
        <section id="SuivideConformite">
            <h2>Suivi de conformité</h2>
			<div class="progress-container">
				<div class="progress-bar" id="progressBar">
					<span id="progressText">0%</span>
				</div>
			</div>
            <div id="SuivideConformiteContent">
				<div class="conformite-section">
					<h3>Politique de confidentialité générale RGPD</h3>
					<input type="file" accept="application/pdf" multiple onchange="handleFiles(event, 'section11')">
					<div id="section11-list"></div>
					<h3>Tiers charte RGPD</h3>
					<input type="file" accept="application/pdf" multiple onchange="handleFiles(event, 'section12')">
					<div id="section12-list"></div>
				</div>
				<div class="conformite-section">
					<h3>Gestion de la demande exercice de droits DCP</h3>
					<input type="file" accept="application/pdf" multiple onchange="handleFiles(event, 'section21')">
					<div id="section21-list"></div>
				</div>
				<div class="conformite-section">
					<h3>Consentement éclairé des collaborateurs</h3>
					<input type="file" accept="application/pdf" multiple onchange="handleFiles(event, 'section31')">
					<div id="section31-list"></div>
				</div>
				<div class="conformite-section">
					<h3>Clause de candidature négative</h3>
					<input type="file" accept="application/pdf" multiple onchange="handleFiles(event, 'section41')">
					<div id="section41-list"></div>
					<h3>Engagement de confidentialité partenaires</h3>
					<input type="file" accept="application/pdf" multiple onchange="handleFiles(event, 'section42')">
					<div id="section42-list"></div>
				</div>
				<div class="conformite-section">
					<h3>Politique de conservation DCP</h3>
					<input type="file" accept="application/pdf" multiple onchange="handleFiles(event, 'section51')">
					<div id="section51-list"></div>
				</div>
				<div class="conformite-section">
					<h3>Charte informatique</h3>
					<input type="file" accept="application/pdf" multiple onchange="handleFiles(event, 'section61')">
					<div id="section61-list"></div>
				</div>
				<div class="conformite-section">
					<h3>Registre des traitements</h3>
					<input type="file" accept="application/pdf" multiple onchange="handleFiles(event, 'section71')">
					<div id="section71-list"></div>
				</div>
				<div class="conformite-section">
					<h3>Gestion de la violation de données</h3>
					<input type="file" accept="application/pdf" multiple onchange="handleFiles(event, 'section81')">
					<div id="section81-list"></div>
				</div>
				<div class="conformite-section">
					<h3>Procédure de contrôle CNIL</h3>
					<input type="file" accept="application/pdf" multiple onchange="handleFiles(event, 'section91')">
					<div id="section91-list"></div>
				</div>
				<div class="conformite-section">
					<h3>Politique externe de protection des données</h3>
					<input type="file" accept="application/pdf" multiple onchange="handleFiles(event, 'section101')">
					<div id="section101-list"></div>
					<h3>Politique interne de protection des données</h3>
					<input type="file" accept="application/pdf" multiple onchange="handleFiles(event, 'section102')">
					<div id="section102-list"></div>
				</div>
			</div>
        </section>

        <!-- Contact & Support -->
        <section id="contactSupport">
            <h2>Contact & Support</h2>
            <form id="contactForm" action="mailto:sr64410@gmail.com" method="post" enctype="text/plain">
                <label for="name">Votre nom :</label>
                <input type="text" id="name" name="name" required>

                <label for="email">Votre email :</label>
                <input type="email" id="email" name="email" required>

                <label for="message">Message :</label>
                <textarea id="message" name="message" rows="5" required></textarea>

                <button type="submit">Envoyer</button>
            </form>
        </section>
    </div>
</main>

<footer>
    <p>&copy; 2025 RGPD Trankility. Tous droits réservés.</p>
</footer>

<script>			
/* --- Gestion utilisateur et onglets --- */
const currentUser = JSON.parse(localStorage.getItem('currentUser'));
if(currentUser) {
    document.getElementById('welcomeMsg').textContent = `Bienvenue, ${currentUser.name} !`;
} else {
    window.location.href = 'login.html';
}

const tabs = document.querySelectorAll('.tab-btn');
const sections = document.querySelectorAll('.content section');

tabs.forEach(tab => {
    tab.addEventListener('click', () => {
        const targetId = tab.dataset.tab;
        tabs.forEach(t => t.classList.toggle('active', t === tab));
        sections.forEach(s => s.classList.toggle('active', s.id === targetId));

        if(targetId === 'historiqueGeneration') showHistory();
        if(targetId === 'FormulaireRGPD') loadFormulaire();
    });
});

/* --- Formulaire RGPD --- */
let formulaireLoaded = false;
async function loadFormulaire() {
    if(formulaireLoaded) return;
    formulaireLoaded = true;
    const res = await fetch("formulaireinformationrgpd.html");
    const html = await res.text();
    document.getElementById("formulaireContainer").innerHTML = html;

    const form = document.getElementById("autoForm");
    if(form){
        const savedData = JSON.parse(localStorage.getItem("autoFormData")) || {};
        Object.entries(savedData).forEach(([key,val])=>{
            const input = document.getElementById(key);
            if(input) input.value = val;
        });
        form.querySelectorAll("input").forEach(input => {
            input.addEventListener("input", () => {
                const data = JSON.parse(localStorage.getItem("autoFormData")) || {};
                data[input.id] = input.value;
                localStorage.setItem("autoFormData", JSON.stringify(data));
            });
        });
        form.addEventListener("submit", e => {
            e.preventDefault();
            alert("Formulaire sauvegardé !");
        });
    }
}

/* --- Génération documents Vercel --- */
document.getElementById("generateBtn").addEventListener("click", async () => {
    const docType = document.getElementById("docSelect").value;
    const msgDiv = document.getElementById("regenResult");
    msgDiv.textContent = "⏳ Génération en cours...";

    if(!docType){ msgDiv.textContent="⚠️ Choisissez un document."; return; }

    let formData = JSON.parse(localStorage.getItem("autoFormData")) || {};
    const requiredFields = ["nom","prenom","entreprise","sigle","adressesiege","cpsiege","villesiege","numtelsiege"];
    const missing = requiredFields.filter(f => !formData[f] || formData[f].trim()==="");
    if(missing.length>0){ msgDiv.textContent="⚠️ Champs manquants: "+missing.join(","); return; }

    try{
        const res = await fetch("api/generate", {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({formData, documentType: docType})
        });
        const data = await res.json();

        if(res.ok){
            // Base64 -> Blob
            const pdfBlob = base64ToBlob(data.pdfBase64, "application/pdf");
            const docxBlob = base64ToBlob(data.docxBase64, "application/vnd.openxmlformats-officedocument.wordprocessingml.document");
            const zipBlob = base64ToBlob(data.zipBase64, "application/zip");

            const pdfUrl = URL.createObjectURL(pdfBlob);
            const docxUrl = URL.createObjectURL(docxBlob);
            const zipUrl = URL.createObjectURL(zipBlob);
			
			// ✅ Création du nom de fichier unique
			const docSelect = document.getElementById("docSelect");
			const documentType = docSelect.value;
            const fileName = `${docType.replace(/\s+/g, "_")}_${Date.now()}`;

            // Historique
            const historyKey = `history_${currentUser.name}`;
            let history = JSON.parse(localStorage.getItem(historyKey)) || [];
            const date = new Date().toLocaleString();
            history.push({date, fileName, pdfUrl, docxUrl, zipUrl});
            localStorage.setItem(historyKey, JSON.stringify(history));

            msgDiv.innerHTML = `
                ✅ Document généré !<br>
                <a href="${pdfUrl}" download="${fileName}.pdf" class="btn-gendoc">PDF</a> |
                <a href="${docxUrl}" download="${fileName}.docx" class="btn-gendoc">Word</a> |
                <a href="${zipUrl}" download="${fileName}.zip" class="btn-gendoc">ZIP</a>
            `;
        } else {
            msgDiv.textContent = "❌ "+data.error;
        }
    } catch(err){
        msgDiv.textContent="❌ Erreur réseau ou serveur";
        console.error(err);
    }
});

function base64ToBlob(base64, type){
    const binary = atob(base64);
    const array = new Uint8Array(binary.length);
    for(let i=0;i<binary.length;i++) array[i] = binary.charCodeAt(i);
    return new Blob([array], {type});
}

/* --- Historique --- */
function showHistory() {
    if(!currentUser) return;
    const historyKey = `history_${currentUser.name}`;
    let history = JSON.parse(localStorage.getItem(historyKey)) || [];
    const historyDiv = document.getElementById('historyList');

    if(history.length === 0){
        historyDiv.innerHTML = "<p>Aucun document généré pour le moment.</p>";
        return;
    }

    historyDiv.innerHTML = '';
    history.slice().reverse().forEach((entry, index) => {
        const div = document.createElement('div');
        div.classList.add('history-item');

        div.innerHTML = `
			<strong>Nom :</strong> ${entry.fileName || "Inconnu"}<br>
            <strong>Généré le :</strong> ${entry.date}<br>
			<a href="${entry.pdfUrl}" download="${entry.fileName}.pdf"><button class="pdf">PDF</button></a>
            <a href="${entry.docxUrl}" download="${entry.fileName}.docx"><button class="word">Word</button></a>
            <a href="${entry.zipUrl}" download="${entry.fileName}.zip"><button  class="zip">ZIP</button></a>
        `;

        const deleteBtn = document.createElement('button');
        deleteBtn.textContent = "❌";
        deleteBtn.classList.add('deleteBtn');
        deleteBtn.title = "Supprimer cet élément";

        deleteBtn.addEventListener('click', () => {
            const realIndex = history.length - 1 - index;
            history.splice(realIndex, 1);
            localStorage.setItem(historyKey, JSON.stringify(history));
            showHistory();
        });

        div.appendChild(deleteBtn);
        historyDiv.appendChild(div);
    });
}

/* --- Suivi de conformité --- */
const filesData = {
    section11: [],
    section12: [],
	section21: [],
	section31: [],
	section41: [],
	section42: [],
	section51: [],
	section61: [],
	section71: [],
	section81: [],
	section91: [],
	section101: [],
	section102: [],
};

function handleFiles(event, section) {
    const uploadedFiles = event.target.files;

    for (let file of uploadedFiles) {
        const fileURL = URL.createObjectURL(file);
        filesData[section].push({ name: file.name, url: fileURL });
    }

    updateSectionList(section);
    updateProgressBar();
}

function updateSectionList(section) {
    const container = document.getElementById(section + "-list");
    container.innerHTML = "";

    filesData[section].forEach((file, index) => {
        const div = document.createElement("div");
        div.className = "file-entry";

        div.innerHTML = `
            <span>${file.name}</span>
            <div>
                <button class="btn-view" onclick="window.open('${file.url}', '_blank')">Voir</button>
                <button class="btn-download" onclick="downloadFile('${file.url}', '${file.name}')">Télécharger</button>
                <button class="btn-delete" onclick="deleteFile('${section}', ${index})">X</button>
            </div>
        `;

        container.appendChild(div);
    });
}

// Supprimer un fichier
function deleteFile(section, index) {
    // Supprime l’élément du tableau
    filesData[section].splice(index, 1);

    // Réinitialise l’input pour pouvoir re-uploader le même fichier
    const input = document.querySelector(`#${section}-list`).previousElementSibling;
    if(input && input.tagName === "INPUT") {
        input.value = "";
    }

    // Met à jour la liste et la barre
    updateSectionList(section);
    updateProgressBar();
}


function downloadFile(url, filename) {
    const a = document.createElement("a");
    a.href = url;
    a.download = filename;
    a.click();
}

function updateProgressBar() {
    const totalSections = 2;
    let completed = 0;

    if (filesData.section11.length > 0) completed++;
	if (filesData.section12.length > 0) completed++;
	if (filesData.section21.length > 0) completed++;
	if (filesData.section31.length > 0) completed++;
	if (filesData.section41.length > 0) completed++;
	if (filesData.section42.length > 0) completed++;
	if (filesData.section51.length > 0) completed++;
	if (filesData.section61.length > 0) completed++;
	if (filesData.section71.length > 0) completed++;
	if (filesData.section81.length > 0) completed++;
	if (filesData.section91.length > 0) completed++;
	if (filesData.section101.length > 0) completed++;
	if (filesData.section102.length > 0) completed++;

    const percentage = Math.round((completed / totalSections) * 100);
    const bar = document.getElementById("progressBar");
    const text = document.getElementById("progressText");

    bar.style.width = percentage + "%";
    text.textContent = percentage + "%";
}

</script>
<script src="header.js"></script>
</body>
</html>
